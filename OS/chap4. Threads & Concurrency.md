# chap4. Threads & Concurrency

> Thread는 CPU의 이용의 기본 단위이다. Thread는 같은 프로세스에 속한 다른 스레드와 코드, 데이터 섹션 그리고 열린 파일이나 신호와 같은 운영체제 자원들을 공유한다.

단일 스레드와 다중 스레드의 차이는 160p 그림 4.1참고

## 4.1 Overview

### 4.1.1 동기(Motivation)

하나의 응용은 몇 개의 실행 흐름을 가진 독립적인 프로세스로 구현된다.

- 이미지들로 부터 포토 섬네일을 만드는 어플리케이션의 경우 각각의 이미지로 부터 섬네일을 생성하는 쓰레드를 갖는다.

- 웹 브라우저는 이미지 또는 텍스트를 표시하는 하나의 스레드와 네트워크로부터 데이터를 가져오는 또다른 스레드를 갖는다.
- 워드 프로세서의 경우 그래픽을 표시하는 스레드와 키보드로부터 입력을 받아 들일 수 있는 스레드, 백그라운드에서 철자법과 문법을 체크하는 스레드를 가질 수 있다.

하나의 응용 프로그램이 여러 개의 비슷한 작업들을 수행할 필요가 있는 상황들도 있다.

- 웹 서버는 클라이언트로부터 웹 페이지나 이미지, 소리 등에 대한 요청을 받는다. 하나의 분주한 웹 서버는 수천 개의 클라이언트들이 병행하게 접근할 수 있다.

만일 단일 프로세스로 한 번에 하나의 클라이언트만 서비스하게 되면 다른 사용자는 매우 긴 시간을 기다려야 한다.

하나의 해결책은 서버가 요청을 받아들이는 하나의 프로세스로 동작하게 하는 것!!

-> 프로세스는 그 요청을 수행할 별도의 프로세스를 생성하는 것(하지만 멀티 스레드를 사용하는 현재에는 굳이 이런 오버해드를 감수할 이유가 없어짐)

현재는 다수의 운영체제 커널은 다중화 되어 있다. 161p 그림 4.2 참고

### 4.1.2 Benefits

- 응답성 - 응용 프로그램의 일부분이 block되거나, 응용프로그램이 긴 작업을 수행하더라도 프로그램의 수행이 계속 되는 것을 허용
- 자원공유 - ***스레드는 자동적으로 그들이 속한 프로세스의 자원들과 메모리를 공유한다.
- 경제성 - 스레드는 자신이 속한 프로세스의 자원들을 공유하기 때문에 생성하고 문맥 교환하는 것이 매우 경제적이다.
- 규모 적응성 - 다중 처리기 구조에서 더욱 증가할 수 있다. 다중 처리기 구조에서는 각각의 스레드가 다른 처리기에서 병렬로 수행될 수 있기 때문

## 4.2 다중코어 프로그래밍

> 단일 CPU 시스템에서 다중 CPU 시스템으로 진화했다.  최근에는 하나의 칩안에 여러 계산 코어를 넣는 것이 유사한 경향이다. 코어가 여러 CPU칩 형태를 띠거나 칩안에 여러 개 존재하는 것을 다중코어 또는 다중 처리기 시스템이라고 부른다.

- Different between Concurrency and Parallelism
  - concurrency(병행) - 모든 태스크가 진행하게끔 함으로서 하나 이상의 태스크를 지원
  - parallelism(병렬) - 하나 이상의 태스크를 동시에 수행할 수 있는 시스템

### 4.2.1 프로그래밍 도전과제

> 운영체제 설계자는 163p 그림 4.4와 같이 병렬 수행이 될 수 있도록 여러 코어를 활용하는 스케줄링 알고리즘을 개발해야한다.

- 태스크 인식 : 병행 가능한 태스크로 나눌 수 있는 영역을 찾는 작업 필요
- 균형 : 전체 작업에 균등한 기어도를 갖도록 태스크 나누기
- 데이터 분리 : 태스크가 접근하고 조작하는 데이터 또한 개별 코어에서 사용할 수 있도록 나누기
- 데이터 종속성 : 태스크가 접근하는 데이터는 둘 이상의 태스크 사이에 종속성이 없는지 검토
- 시험 및 디버깅 : 병행 프로그램을 시험하고 디버깅하는 것

### 4.2.2 병렬 실행의 유형

- 데이터 병렬 실행 : 동일한 데이터의 부분집합을 다수의 계산 코어에 분배 한 뒤 각 코어에서 동일한 연산을 실행하는데 초점
- 태스크 병렬 실행 : 데이터가 아니라 테스크(Thread)를 다수의 코어에 분배 한다. 각 스레드는 공유의 연산을 실행

## 4.3 다중 스레드 모델

> Thread를 위한 자원은 사용자 스레드와 커널 스레드로 존재한다.

### 4.3.1 다대일 모델(Many-to-One Model)

많은 사용자 수준의 스레드를 하나의 커널 스레드로 사상(map)한다.

- 장점 : 스레드 관리는 사용자 공간의 스레드 라이브러리에 의해 행해진다.
- 단점 : blocking system call의 경우 모든 프로세스가 blocking된다. 그리고 한 번에 하나의 스레드만이 커널에 접근할 수 있기 때문에 다중 스레드가 다중코어 시스템에서 병렬로 실핼 될 수 없다.

### 4.3.2 일대일 모델(One-to-One Model)

각 사용자 스레드를 각각 하나의 커널 스레드로 사상(map)한다.

- 장점 : blocking system call에도 모든 프로세스가 멈추지 않는다.
- 단점 : 사용자 수준의 스레드를 생성할 때 무조건 커널 스레드도 만들어야한다.

### 4.3.3 다대다 모델(Many-to-Many Model)

여러 개의 사용자 수준 스레드를 그보다 작은 수 혹은 같은 수의 커널 스레드로 multiplexe한다.

- 장점 : 다중 처리기에서 더 많은 커널 스레드를 할당 받을 수 있어서 효율이 좋다.
- 한계점 : 한 번에 하나의 스레드만이 커널에 의해서 스케줄 되기 때문에 진정한 병렬 실행을 할 수 없다.

그래서 등장한게 two-level model이다.

다대다 모델의 변형은 여전히 많은 사용자 스레드를 적거나 같은 수의 커널 스레드로 멀티플렉스 시키지만 한 사용자 스레드가 하나의 커널 스레드에만 연관되는 것을 허용하여 개발자가 한 응용 내에 너무 많은 스레드를 생성하지 않도록 한다. 168p 그림 4.10 참고